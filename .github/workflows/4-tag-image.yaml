---
name: tag-image
# description:
# Gets image from github registry, retags, and pushes to docker registry

on: # yamllint disable-line rule:truthy
  workflow_call:
    inputs:
      gh_registry:
        description: Github registry (ghcr.io/<OWNER>)
        required: true
        type: string
      d_registry:
        description: Docker registry (docker.io/<OWNER>)
        required: true
        type: string
      image_name:
        description: Image name
        required: true
        type: string
      image_digest:
        description: SHA digest of image
        required: true
        type: string
      short_nametag:
        description: Image name and short tag (image:python-<major.minor>)
        required: true
        type: string
      long_nametag:
        description: Image name and long tag (image:python-<major.minor>-<sha>)
        required: true
        type: string
  workflow_dispatch:


jobs:
  ### possible issues with macOS/arm64
  # https://github.com/github/roadmap/issues/528
  # https://github.com/actions/setup-python/issues/547
  tag-image-runner:
    runs-on: ubuntu-latest

    # push to registry on main branch only
    steps:
      - name: Login to DockerHub âœ…
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USER }}
          password: ${{ secrets.DOCKER_TOKEN }}

      # copy image from ghcr to dockerhub
      - name: Push image to alternate registries ðŸ’¾
        uses: akhilerm/tag-push-action@v2.1.0
        with:
          src: ${{ inputs.gh_registry }}/${{ inputs.image_name }}@${{ inputs.image_digest }}
          dst: |
            ${{ inputs.d_registry }}/${{ inputs.short_nametag }}
            ${{ inputs.d_registry }}/${{ inputs.long_nametag }}
