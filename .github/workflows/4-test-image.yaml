---
name: test-image
# description:
# Load and run tests from jupyter/docker-stacks (https://github.com/jupyter/docker-stacks)

on: # yamllint disable-line rule:truthy
  workflow_call:
    inputs:
      runs_on:
        description: Github-hosted runner type
        required: true
        type: string
      gh_registry:
        description: Github registry (ghcr.io/<owner>)
        required: true
        type: string
      owner:
        description: Registry name
        required: true
        type: string
      image_name:
        description: Image name
        required: true
        type: string
      image_digest:
        description: SHA digest of image
        required: true
        type: string
  workflow_dispatch:


jobs:
  ### possible issues with macOS/arm64
  # https://github.com/github/roadmap/issues/528
  # https://github.com/actions/setup-python/issues/547
  test-image-runner:
    runs-on: ${{ inputs.runs_on }}
    steps:
      - name: Checkout Repo ğŸ›’
        uses: actions/checkout@v3

      - name: Set Up Python ğŸ
        uses: actions/setup-python@v4
        with:
          python-version: 3.x
        # if: ${{ inputs.platform == 'x86_64' }}

      - name: Install Dev Dependencies ğŸ“¦
        shell: bash
        run: |
          pip install --upgrade pip
          pip install --upgrade -r requirements-dev.txt

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull image ğŸ“¥
        shell: bash
        run: |
          # pull image by sha
          docker pull "${{ inputs.gh_registry }}/${{ inputs.image_name }}@${{ inputs.image_digest }}"
          # retag with 'latest' for test script
          docker tag \
            "${{ inputs.gh_registry }}/${{ inputs.image_name }}@${{ inputs.image_digest }}" \
            "${{ inputs.owner }}/${{ inputs.image_name }}:latest"
          # check work
          docker image list
        # env:
        #   GH_REGISTRY: ${{ inputs.gh_registry }}
        #   # OWNER: ${{ inputs.owner }}
        #   IMAGE_NAME: ${{ inputs.image-name }}
        #   IMAGE_DIGEST: ${{ inputs.image-digest }}

      ### Load and run tests from jupyter/docker-stacks (https://github.com/jupyter/docker-stacks)
      - name: Run tests ğŸ§ª
        shell: bash
        run: python3 -m tests.run_tests --short-image-name ${{ inputs.image_name }} --owner ${{ inputs.owner }}
        # env:
        #   OWNER: ${{ inputs.owner }}
        #   IMAGE_NAME: ${{ inputs.image-name }}
