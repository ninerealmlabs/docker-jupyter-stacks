---
name: base-env

on: # yamllint disable-line rule:truthy
  schedule:
    # # at: 01:00 on the first of every month
    - cron: "0 1 1 * *"
  pull_request:
    paths-ignore:
      # - ".github/**"
      - docs/**
      - scripts/**
      - '*.md'
      - '**/.gitignore'
      - docker-compose.yaml
      - LICENSE
  push:
    branches:
      - main
    paths-ignore:
      # - ".github/**"
      - docs/**
      - scripts/**
      - '*.md'
      - '**/.gitignore'
      - docker-compose.yaml
      - LICENSE
  workflow_dispatch:

# https://docs.github.com/en/actions/using-jobs/using-concurrency
concurrency:
  # only cancel in-progress jobs or runs for the current workflow - matches against branch & tags
  group: ${{ github.workflow }}-${{ github.ref }}
  # group: ${{ github.ref }}
  cancel-in-progress: true

# define static vars here
env:
  image_name: base-env
  platforms: "linux/amd64,linux/arm64"
  gh_registry: ghcr.io/ninerealmlabs
  d_registry: docker.io/ninerealmlabs
  owner: ninerealmlabs
  source_image: jupyter/minimal-notebook
  source_tag: latest
  source_digest: ''

jobs:
  build: # used for image name
    runs-on: self-hosted

    strategy:
      # https://docs.github.com/en/actions/using-jobs/using-a-matrix-for-your-jobs
      # sadly, there's no way to set dependencies between matrix-generated jobs
      matrix:
        python_version: [3.8.*] # , 3.9.*, 3.10.*]

    # if: github.repository == 'ninerealmlabs/docker-jupyter-stacks'
    # if: ${{ github.event.workflow_run.conclusion == 'success' }}
    steps:
      ### --- Prep -----------------------------------------------------------
      # https://stackoverflow.com/questions/70483902/how-to-actually-clean-up-the-repository-on-self-hosted-runner-after-github-actio
      - name: Cleanup build folder üßπ
        shell: bash
        run: |
          cd ${{ github.workspace }}
          ls -la ./
          rm -rf ./* || true
          rm -rf ./.??* || true
          ls -la ./

      - name: Checkout Repo üõí
        uses: actions/checkout@v3
        # allow workflow_run to trigger on non-main branch:
        # https://stackoverflow.com/questions/63343937/how-to-use-the-github-actions-workflow-run-event
        with:
          ref: ${{ github.ref }}

      ### unneeded in initial job
      # - name: Read passed inputs üìñ
      #   id: source_inputs
      #   uses: ./.github/actions/read-artifact
      #   # with:
      #   #   artifact_name: vars

      - name: Login to GitHub Container Registry ‚úÖ
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      ### --- Build ----------------------------------------------------------
      - name: Build Image üõ†
        id: build
        uses: ./.github/actions/build-image-action
        with:
          source_image: ${{ env.source_image }}
          source_tag: ${{ env.source_tag }}
          source_digest: ${{ env.source_digest }}
          image_name: ${{ env.image_name }}
          python_version: ${{ matrix.python_version }}
          platforms: ${{ env.platforms }}
          gh_registry: ${{ env.gh_registry }}
          owner: ${{ env.owner }}

      # ### --- Test -----------------------------------------------------------
      # - name: Test Image üß™
      #   id: test
      #   uses: ./.github/actions/test-image-action
      #   with:
      #     gh_registry: ${{ env.gh_registry }}
      #     owner: ${{ env.owner }}
      #     image_name: ${{ env.image_name }}
      #     image_digest: ${{ steps.build.outputs.digest }}

      ### --- Pass -----------------------------------------------------------
      - name: Save outputs to artifacts üíæ
        uses: ./.github/actions/save-artifact-action
        with:
          image_name: ${{ env.image_name }}
          python_version: ${{ matrix.python_version }}
          python_tag: ${{ steps.build.outputs.python_tag }}
          git_tag: ${{ steps.build.outputs.git_tag }}
          image_digest: ${{ steps.build.outputs.image_digest }}

      ### --- Push to Dockerhub ----------------------------------------------
      # push to registry on main branch only
      - if: github.ref_name == 'main'
        name: Login to DockerHub ‚úÖ
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USER }}
          password: ${{ secrets.DOCKER_TOKEN }}

      - if: github.ref_name == 'main'
        name: Tag & Push image to docker üè∑
        uses: akhilerm/tag-push-action@v2.1.0
        with:
          src: ${{ env.gh_registry }}/${{ env.image_name }}@${{ steps.build.outputs.digest }}
          dst: |
            ${{ env.d_registry }}/${{ env.image_name }}:${{ steps.build.outputs.python_tag }}
            ${{ env.d_registry }}/${{ env.image_name }}:${{ steps.build.outputs.python_tag }}-${{ steps.build.outputs.git_tag }}
